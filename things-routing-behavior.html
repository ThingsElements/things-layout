<link rel="import" href="../things-detail/things-menu-detail-view.html">

<script>
'use strict';

window.Things = window.Things || {};

/**
 * ## things-sidebar.html 에 사용될 RoutingBehavior이다.
 *
 * @polymerBehavior Things.RoutingBehavior
 */
Things.RoutingBehavior = {

  properties: {
    /**
     * 현재 선택된 메뉴의 상세 정보
     * *******
     * @type {Object}
     */
    currentScreen: {
      type: Object,
      notify: true
    }

    /**
     * 최근 방문한 페이지가 추가되었음을 알리는 이벤트
     *
     * @event things-recent-page-added
     */
    /**
     * 현재 라우팅이 변경되었음을 알리는 이벤트
     * {routing}은 현재 라우팅 값으로 대체됨
     *
     * @event things-routing-changed-{routing}
     */    
  },

  /**
   * routings 초기화
   * *********
   * @param {String} defaultRouting ### :기본 라우팅 값 
   * @param {Array} screens #### :현재 화면에서 조회된 모든 메뉴 정보
   *
   */
  init: function(defaultRouting, screens) {
    var me = this;

    var defaultRoutingScreen = screens.filter(function(object) {
      return ('/' + object.routing) == defaultRouting
    });
    
    defaultRoutingScreen.length > 0 ? 
      this.addDefaultRouting(defaultRouting,screens) : 
      this.addDefaultRouting('/', screens);

    screens.forEach(function(screen) {
      var route = screen.routing;
      if (route) {
        page('/' + route, me.scrollToTop, function(ctx) {
          app.route = screen.routing;

          // Dynamic Menu라면 Element가 등록되었는지 확인한 후 등록이 안 되었다면 등록한다.
          if(!screen.isRegistered) {
            var routingType = screen.routing_type;

            if(routingType == 'RESOURCE') {
              me._registerResourceScreen(screen);

            } else if(routingType == 'RESOURCE-VIEW') {
              me._registerResourceViewScreen(screen);

            } else if(routingType == 'PLAIN') {
              me._registerPlainScreen(screen);

            } else if(screen.routing_type == 'REPORT') {
              me._registerReportScreen(screen);

            } else if (screen.routing_type == 'VIEWER') {
              me._registerSceneViewerScreen(screen);

            } else if (screen.routing_type == 'PLAYER') {
              me._registerScenePlayerScreen(screen);

            } else {
              me._registerStaticScreen(screen);
            }

            screen.isRegistered = true;
          }

          // 1. currentScreen 변경
          me.currentScreen = screen;
          var eventDetail = { 
            pageName: screen.title, 
            routeInfo: screen.routing, 
            category: screen.category, 
            initialParams : ctx.state 
          };

          // 2. 라우팅 변경 이벤트 ...
          var routingChangedEventName = 'things-routing-changed-' + screen.routing;
          var routeChangeEvent = new CustomEvent(routingChangedEventName, { detail : eventDetail });
          document.dispatchEvent(routeChangeEvent);

          // 3. Recent Page 추가 이벤트 ...
          var recentPageAddEvent = new CustomEvent('things-recent-page-added', { detail: eventDetail });
          document.dispatchEvent(recentPageAddEvent);
        });
      }
    });

    this.addLastRouting();
  },

  /**
   * 메뉴 정보를 이용하여 화면을 화면 레이아웃의 Content 영역에 등록한다.
   * **********
   * @param {Object} screen 화면 오브젝트
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _setCommonScreenInfo: function(screen, menuData) {
    screen.menuInfo = menuData;
    screen.dataRoute = menuData.routing;
    screen.id = menuData.routing;
    var content = document.querySelector('#' + this.pageContentId);
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();
  },

  /**
   * RESOURCE 타입 (화면 유형 : 검색 폼 - 그리드 화면 구성에 그리드 Row 클릭시 Detail Popup 화면)의 Dynamic Screen을 등록한다.
   * ******
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerResourceScreen: function(menuData) {
    var screenName = (menuData.category == 'TERMINAL') ? 'things-menu-detail-view' : 'things-resource-menu-content';
    var screen = document.createElement(screenName);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * RESOURCE-VIEW 타입 (화면 유형 : 검색 폼 - 그리드 - 디테일 폼)의 Dynamic Screen을 등록한다.
   * ********
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerResourceViewScreen: function(menuData) {
    var screen = document.createElement('things-standard-menu-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * PLAIN 타입 (화면 유형 : 검색 폼 - 그리드 화면 구성)의 Plain Screen을 등록한다.
   * 화면은 메뉴의 메타 정보로 그려내고 서비스 호출 URL도 화면의 메뉴 메타 정보로 사용한다.
   * 단순하게 서비스 호출하여 조회된 데이터로 그리드를 그리는 화면 유형
   * ********
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerPlainScreen: function(menuData) {
    var screen = document.createElement('things-menu-grid-content');
    this._setCommonScreenInfo(screen, menuData);
  },  

  /**
   * Report 타입 (조회 중심의 그리드 기반의 화면 구성)의 Screen을 등록한다.
   * 화면은 DiyGrid 기반으로 그려내고 서비스 호출 URL도 화면의 메뉴 메타 정보로 사용한다.
   * ********
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerReportScreen: function(menuData) {
    var screen = document.createElement('things-report-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * SCENE VIEWER 타입(검색 폼 - Scene Viewer)의 Screen을 등록한다.
   * ******
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerSceneViewerScreen: function(menuData) {
    var screen = document.createElement('things-scene-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * SCENE PLAYER 타입의 화면을 등록한다 menuData의 detail_form_id를 통해
   * Scene Player에 포함될 Scene들을 전달한다.
   * *******
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerScenePlayerScreen: function(menuData) {
    var screen = document.createElement('things-scene-player');
    screen.setAttribute('play-pages', menuData.detail_form_id);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * STATIC 타입(개발자가 임의의 화면 구성)의 Screen을 등록한다.
   * ********
   * @param {Object} menuData 현재 선택된 메뉴 정보
   */
  _registerStaticScreen: function(menuData) {
    var screen = document.createElement(menuData.template);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * move screen scroll to top
   * ********
   * @param {Object} ctx
   * @param {Function} next
   */
  scrollToTop: function(ctx, next) {
    //app.scrollPageToTop();
    next();
  },

  /**
   * Default Routing 추가 
   * *********
   * @param {String} defaultRouting 기본 라우팅 
   * @param {Array} screens 화면에서 조회한 모든 메뉴 정보 리스트 
   */
  addDefaultRouting: function(defaultRouting, screens) {
    page('/' + defaultRouting, this.scrollToTop, function() {
      app.route = defaultRouting;
    });

    var defaultRoutingExists = screens.filter(function(object) {
      return ('/' + object.routing) == defaultRouting
    }).length > 0;

    if(defaultRoutingExists) {
      page('/', this.scrollToTop, function() {
        if(defaultRouting !== 'home') {
          page.redirect(defaultRouting);
        } else {
          app.route = '/';
        }
      });
    }
  },

  /**
   * LoginRouting 추가
   * *********
   * @param {String} loginRouting LoginRouting
   */
  addLoginRouting: function(loginRouting) {
    page('/login', this.scrollToTop, function() {
      app.route = loginRouting;
    });

    page('/', this.scrollToTop, function() {
        app.route = '/';
    });

    page({ hashbang: true });
  },

  /**
   * add last routing, when page not foud redirect to home
   * *********
   */
  addLastRouting: function() {
    page('*', function(attempted) {
      var url = window.location.href + attempted.path.substr(1);
      var msg = `Can't find: ${url}. Redirected to Home Page`;
      var event = new CustomEvent('things-show-toast', { detail: { msg: msg } });
      document.dispatchEvent(event);
      page.redirect('/');
    });

    page({ hashbang: true });
    
    if(app.dataRoute !== window.location.hash.replace('#!/', '')) {
      page('/' + window.location.hash.replace('#!/', ''))
    }
  }
};

</script>