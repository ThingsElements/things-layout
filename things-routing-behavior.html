<link rel="import" href="../things-detail/things-menu-detail-view.html">

<script>
'use strict';

window.Things = window.Things || {};

/**
 * This behavior is for routing registration when menu or other element need to use routing registration.
 * On standard we used this behavior on things-sidebar.html
 * 
 * @polymerBehavior Things.RoutingBehavior
 */
Things.RoutingBehavior = {

  properties: {
    /**
     * 현재 선택된 메뉴의 상세 정보 
     */
    currentScreen: {
      type: Object,
      notify: true
    },

    /**
     * Play할 페이지 리스트 
     */
    pagesToPlay: {
      type: Array,
      value:[]
    },

    /**
     * Playing interval
     */
    playInterval: {
      type: Number,
      value: 10000
    },

    /**
     * Playing index
     */
    _playingIndex: {
      type: Number,
      value: 0
    },

    /**
     * Async player
     */
    _asyncPlayer: {
      type: Object
    }
  },

  /**
   * Initialize routings
   *
   * @param {Array} Menu screen informations
   * @param {String} Defualt routing name
   * @param {String} Login routing name  
   */
  init: function(screens, defaultRouting, loginRouting) {
    var me = this;
    this.addDefaultRouting(defaultRouting, loginRouting);

    screens.forEach(function(screen) {
      var route = screen.routing;
      if (route) {
        page('/' + screen.routing, me.scrollToTop, function(ctx) {
          app.route = screen.routing;

          // Dynamic Menu라면 Element가 등록되었는지 확인한 후 등록이 안 되었다면 등록한다.
          if(!screen.isRegistered) {
            var routingType = screen.routing_type;

            if(routingType == 'RESOURCE') {
              me._registerResourceScreen(screen);

            } else if(routingType == 'RESOURCE-VIEW') {
              me._registerResourceViewScreen(screen);

            } else if(screen.routing_type == 'DIY-GRID') {
              me._registerDiyGridScreen(screen);

            } else if(screen.routing_type == 'DIY-FORM') {
              me._registerDiyFormScreen(screen);

            } else if(screen.routing_type == 'REPORT') {
              me._registerReportScreen(screen);

            } else if (screen.routing_type == 'VIEWER') {
              me._registerSceneViewerScreen(screen);

            } else if (screen.routing_type == 'VIEWER-SECTION') {
              me._registerSceneViewerSectionScreen(screen);

            } else if (screen.routing_type == 'PLAIN-GRID') {
              me._registerPlainGridScreen(screen);

            } else {
              me._registerStaticScreen(screen);
            }

            screen.isRegistered = true;
          }

          // 1. currentScreen 변경 
          me.currentScreen = screen;
          var eventDetail = { pageName: screen.title, routeInfo: screen.routing, category: screen.category, initialParams : ctx.state };          

          // 2. 라우팅 변경 이벤트 ...
          var routeChangeEvent = new CustomEvent('things-routing-changed-' + screen.routing, { detail : eventDetail });
          document.dispatchEvent(routeChangeEvent);

          // 3. Recent Page 추가 이벤트 ...
          var recentPageAddEvent = new CustomEvent('things-recent-page-added', { detail: eventDetail });
          document.dispatchEvent(recentPageAddEvent);
        });
      }
    });

    this.addLastRouting();
  },

  /**
   * RESOURCE 타입 (검색 폼 - 그리드 화면 구성에 그리드 Row 클릭시 Detail Popup 화면 표시) 의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} screen
   * @param {Object} menuData
   */
  _setCommonScreenInfo: function(screen, menuData) {
    screen.menuInfo = menuData;
    screen.dataRoute = menuData.routing;
    screen.id = menuData.routing;
    var content = document.querySelector('#' + this.pageContentId);
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();
  },

  /**
   * RESOURCE 타입 (검색 폼 - 그리드 화면 구성에 그리드 Row 클릭시 Detail Popup 화면 표시) 의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerResourceScreen: function(menuData) {
    var screenName = (menuData.category == 'TERMINAL') ? 'things-menu-detail-view' : 'things-resource-menu-content';
    var screen = document.createElement(screenName);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * RESOURCE-VIEW 타입 (검색 폼 - 그리드 - 디테일 폼 화면 구성) 의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerResourceViewScreen: function(menuData) {
    var screen = document.createElement('things-standard-menu-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * DIY-GRID 타입 (검색 폼 - DIY Grid 기반의 화면 구성) 의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerDiyGridScreen: function(menuData) {
    var screen = document.createElement('things-diy-grid-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * DIY-FORM 타입 (검색 폼 - DIY Form 기반의 화면 구성) 의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerDiyFormScreen: function(menuData) {
    var screen = document.createElement('things-diy-form-content');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * Report 타입 (조회 중심의 그리드 기반의 화면 구성) 의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerReportScreen: function(menuData) {
    var screen = document.createElement('things-report-content');
    this._setCommonScreenInfo(screen, menuData);
  }, 

  /**
   * SCENE VIEWER 타입(검색 폼 - Scene Viewer)의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerSceneViewerScreen: function(menuData) {
    var screen = document.createElement('things-scene-content');
    document.addEventListener('things-toggle-play-pages_' + menuData.routing, this.togglePlayPages);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * SCENE VIEWER과 동일하지만 검색 폼이 없는 화면 구성의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerSceneViewerSectionScreen: function(menuData) {
    var screen = document.createElement('things-scene-section');
    screen.setAttribute('resource-url', menuData.resource_url);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * PLAIN GRID (검색 폼 - 그리드) 타입의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerPlainGridScreen: function(menuData) {
    var screen = document.createElement('things-menu-grid-section');
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * STATIC 타입(개발자가 임의의 화면 구성)의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerStaticScreen: function(menuData) {
    var screen = document.createElement(menuData.template);
    this._setCommonScreenInfo(screen, menuData);
  },

  /**
   * move screen scroll to top
   */
  scrollToTop: function(ctx, next) {
    //app.scrollPageToTop();
    next();
  },

  /**
   *  add default routing
   *  @param {String} Default routing name
   */
  addDefaultRouting: function(defaultRouting, loginRouting) {
    page('/' + defaultRouting, this.scrollToTop, function() {
      app.route = defaultRouting;
    });

    page('/', this.scrollToTop, function() {
      if(defaultRouting !== 'home') {
        page.redirect(defaultRouting);
      } else {
        app.route = defaultRouting;
      }
    });

    page('/login', this.scrollToTop, function() {
      app.route = loginRouting;
    });
  },

  /**
   * add last routing, when page not foud redirect to home
   */
  addLastRouting: function() {
    page('*', function(attempted) {
      var url = window.location.href + attempted.path.substr(1);
      var msg = `Can't find: ${url}. Redirected to Home Page`;
      var event = new CustomEvent('things-show-toast', { detail: { msg: msg } });
      page.redirect('/');
    });
    
    page({ hashbang: true });
  },

  /**
   * Toggle play pages
   */
  togglePlayPages: function(event) {
    var status = event.detail;
    if(status == 'on') {
      this.parsePagesToPlay();
      this.startPlayPages();
    } else {
      this.stopPlayPages();
    }
  },

  /**
   * 메뉴의 상세 정보에서 Play할 route 리스트를 파싱 
   */
  parsePagesToPlay: function() {
    if(this.currentScreen.detail_form_id && this.currentScreen.detail_form_id.length > 1) {
      this.pagesToPlay = this.currentScreen.detail_form_id.split(',');
      this.pagesToPlay.unshift(this.currentScreen.routing);      
    } else {
      this.pagesToPlay = [];
    }
  },

  /**
   * Start play pages
   */
  startPlayPages: function() {
    var playingCount = this.pagesToPlay ? this.pagesToPlay.length : 0;
    if(playingCount <= 1) return;

    this._asyncPlayer = this.async(this.startPlayPages, this.playInterval);
    page('/' + this.pagesToPlay[this._playingIndex]);
    this._playingIndex++;
    if(this._playingIndex >= playingCount) this._playingIndex = 0;
  },

  /**
   * Stop play pages
   */
  stopPlayPages: function() {
    if(!this._asyncPlayer) return;
    this.cancelAsync(this._asyncPlayer);
    this._asyncPlayer = null;
    this._playingIndex = 0;
    page('/' + this.pagesToPlay[0]);
  }
};

</script>